# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: "3"

vars:
  ## Roots under ~/git that may contain repositories
  GIT_ROOTS: "repos sparse-clones worktrees"

  ## Max directory depth to scan under each root
  GIT_MAX_DEPTH: "6"

  ## Parallelism for fetch-all
  FETCH_JOBS: "6"

tasks:
  status-all:
    desc: Show dirty git status for all repositories
    cmds:
      - platforms: [linux, darwin]
        cmd: |-
          set -u

          for root in repos sparse-clones worktrees; do
            [ -d "$root" ] || continue

            echo
            echo "## $root"
            echo

            export GIT_CEILING_DIRECTORIES="$PWD/$root"

            find "$root" \
              -mindepth 1 \
              -maxdepth 6 \
              -type d | while read -r dir; do

                is_worktree="$(git -C "$dir" rev-parse --is-inside-work-tree 2>/dev/null || true)"

                if [ "$is_worktree" = "true" ]; then
                  status="$(git -C "$dir" status --porcelain 2>/dev/null || true)"
                  if [ -n "$status" ]; then
                    echo "=== $(realpath --relative-to="$PWD" "$dir") ==="
                    echo "$status"
                  fi
                fi

              done
          done

  fetch-all:
    desc: Fetch --all --prune for all repositories (parallel, worktree only)
    cmds:
      - platforms: [linux, darwin]
        cmd: |-
          set -u

          for root in repos sparse-clones worktrees; do
            [ -d "$root" ] || continue

            echo
            echo "## $root"
            echo

            export GIT_CEILING_DIRECTORIES="$PWD/$root"

            find "$root" -mindepth 1 -maxdepth 6 -type d | while read -r dir; do

              is_worktree="$(git -C "$dir" rev-parse --is-inside-work-tree 2>/dev/null || true)"

              if [ "$is_worktree" = "true" ]; then
                echo "=== $(realpath --relative-to="$PWD" "$dir") ==="
                git -C "$dir" fetch --all --prune 2>/dev/null || echo "(fetch failed)"
              fi

            done
          done
